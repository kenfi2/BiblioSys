<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BiblioSys - Sistema de Controle de Biblioteca</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .login-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 3rem;
      width: 100%;
      max-width: 450px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h1 {
      font-size: 2.5rem;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .login-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #555;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
    }

    .btn {
      width: 100%;
      padding: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .test-credentials {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .test-credentials p {
      margin: 0.3rem 0;
    }

    header {
      background: rgba(44, 62, 80, 0.95);
      color: white;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-left h1 {
      font-size: 2rem;
    }

    .header-left p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      text-align: right;
    }

    .user-info p {
      margin: 0.2rem 0;
    }

    nav {
      background: rgba(52, 73, 94, 0.95);
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .nav-buttons {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: #7f8c8d;
      border: none;
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      white-space: nowrap;
    }

    .nav-btn:hover {
      background: #95a5a6;
      transform: translateY(-2px);
    }

    .nav-btn.active {
      background: linear-gradient(45deg, #667eea, #764ba2);
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 1rem;
    }

    .card {
      background: white;
      padding: 2rem;
      margin-bottom: 2rem;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .card h2 {
      margin-bottom: 1.5rem;
      color: #2c3e50;
      font-size: 1.8rem;
      border-bottom: 3px solid #667eea;
      padding-bottom: 0.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 1.5rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 1rem;
      opacity: 0.9;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: linear-gradient(45deg, #34495e, #2c3e50);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge-primary {
      background: #cce5ff;
      color: #004085;
    }

    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .message.success { background: #28a745; }
    .message.error { background: #dc3545; }
    .message.warning { background: #ffc107; color: #333; }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .config-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border: 2px solid #90caf9;
      padding: 1.5rem;
      border-radius: 10px;
      margin-top: 2rem;
    }

    .config-info h3 {
      color: #1976d2;
      margin-bottom: 1rem;
    }

    .config-info ul {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
    }

    .config-info li {
      margin: 0.5rem 0;
    }

    .info-box {
      background: white;
      padding: 1rem;
      border: 1px solid #90caf9;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .row-overdue {
      background-color: #fff5f5 !important;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.9rem;
      }

      th, td {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    let currentUser = null;
    let currentSection = 'dashboard';
    
    let books = [];
    let members = [];
    let staff = [];
    let loans = [];
    let reservations = [];
    let notifications = [];
    
    let systemConfig = {
      loanDays: 14,
      toleranceDays: 2,
      maxLoansPerMember: 3,
      allowRenewal: true,
      renewalDays: 7
    };

    async function init() {
      await loadData();
      render();
    }

    async function loadData() {
      try {
        const [booksRes, membersRes, loansRes, reservationsRes, notificationsRes] = await Promise.all([
          fetch('/api/books'),
          fetch('/api/members'),
          fetch('/api/loans'),
          fetch('/api/reservations'),
          fetch('/api/notifications')
        ]);

        books = await booksRes.json();
        members = await membersRes.json();
        loans = await loansRes.json();
        reservations = await reservationsRes.json();
        notifications = await notificationsRes.json();

        staff = [
          { id: 1, name: "Ana Silva", email: "ana@biblioteca.com", password: "123456", role: 'librarian', active: true },
          { id: 2, name: "Maria Costa", email: "maria@biblioteca.com", password: "123456", role: 'manager', active: true },
          { id: 3, name: "Admin", email: "admin@biblioteca.com", password: "admin", role: 'admin', active: true }
        ];
      } catch(error) {
        console.error('Erro ao carregar dados:', error);
      }
    }

    function showMessage(text, type = 'success') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      document.body.appendChild(messageDiv);

      setTimeout(() => messageDiv.remove(), 3000);
    }

    function getRoleLabel(role) {
      const roles = {
        admin: 'Administrador',
        manager: 'Gestor',
        librarian: 'Bibliotec√°rio(a)',
        member: 'Membro(a)'
      };
      return roles[role] || role;
    }

    function canAccess(requiredRoles) {
      if(!currentUser)
        return false;
      return requiredRoles.includes(currentUser.role);
    }

    function getOverdueLoans() {
      const now = new Date();
      return loans.filter(loan => {
        if(loan.status !== 'Active')
          return false;
        const returnDate = new Date(loan.returnDate);
        const toleranceDate = new Date(returnDate);
        toleranceDate.setDate(toleranceDate.getDate() + systemConfig.toleranceDays);
        return now > toleranceDate;
      });
    }

    function isLoanOverdue(loan) {
      if(loan.status !== 'Active')
        return false;
      const now = new Date();
      const returnDate = new Date(loan.returnDate);
      const toleranceDate = new Date(returnDate);
      toleranceDate.setDate(toleranceDate.getDate() + systemConfig.toleranceDays);
      return now > toleranceDate;
    }

    async function handleLogin(e) {
      e.preventDefault();
      e.stopPropagation();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      const user = staff.find(s => s.email === email && s.password === password && s.active);

      console.log(email, password);

      if(user) {
        currentUser = user;
        currentSection = 'dashboard';
        showMessage(`Bem-vindo(a), ${user.name}!`, 'success');
        render();
        return
      }

      const membersRes = await fetch('/api/members');
      const membersData = await membersRes.json();

      const member = membersData.find(m => m.email === email);
      if(member) {
        currentUser = {
          id: member.id,
          name: member.name,
          email: member.email,
          role: 'member',
          active: true
        };

        currentSection = 'books';
        showMessage(`Bem-vindo(a), ${member.name}!`, 'success');
        render();
        return;
      }

      showMessage('Credenciais inv√°lidas!', 'error');
    }

    function handleLogout() {
      currentUser = null;
      currentSection = 'dashboard';
      render();
    }

    function navigateTo(section) {
      currentSection = section;
      render();
    }

    async function handleAddBook(e) {
      e.preventDefault();
      e.stopPropagation();

      const form = e.target;
      const bookData = {
        title: form.title.value,
        author: form.author.value,
        category: form.category.value,
        count: parseInt(form.count.value)
      };

      try {
        const response = await fetch('/api/books', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookData)
        });

        if(response.ok) {
          const book = await response.json();
          books.push(book);
          form.reset();
          showMessage('Livro cadastrado com sucesso!');
          render();
        }
      } catch(error) {
        showMessage('Erro ao cadastrar livro!', 'error');
      }
    }

    async function handleAddMember(e) {
      e.preventDefault();
      e.stopPropagation();

      const form = e.target;
      const memberData = {
        name: form.name.value,
        contact: form.contact.value,
        email: form.email.value
      };

      try {
        const response = await fetch('/api/members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(memberData)
        });

        if(response.ok) {
          const member = await response.json();
          members.push(member);
          form.reset();
          showMessage('Leitor cadastrado com sucesso!');
          render();
        }
      } catch(error) {
        showMessage('Erro ao cadastrar leitor!', 'error');
      }
    }

    function handleAddStaff(e) {
      e.preventDefault();
      e.stopPropagation();

      const form = e.target;
      const newStaff = {
        id: Date.now(),
        name: form.staffName.value,
        email: form.staffEmail.value,
        password: form.staffPassword.value,
        role: form.staffRole.value,
        active: true
      };

      staff.push(newStaff);
      form.reset();
      showMessage('Funcion√°rio cadastrado com sucesso!');
      render();
    }

    async function handleAddLoan(e) {
      e.preventDefault();
      e.stopPropagation();

      const form = e.target;
      const bookId = parseInt(form.loanBook.value);
      const memberId = parseInt(form.loanMember.value);

      const book = books.find(b => b.id === bookId);
      const member = members.find(m => m.id === memberId);

      if(!book || book.available <= 0) {
        showMessage('Livro n√£o dispon√≠vel!', 'error');
        return;
      }

      if(member.activeLoans >= systemConfig.maxLoansPerMember) {
        showMessage('Limite de empr√©stimos atingido!', 'error');
        return;
      }

      const loanDate = new Date();
      const returnDate = new Date(loanDate);
      returnDate.setDate(returnDate.getDate() + systemConfig.loanDays);

      try {
        const response = await fetch('/api/loans', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookId,
            memberId,
            loanDate: loanDate.toISOString(),
            returnDate: returnDate.toISOString()
          })
        });

        if(response.ok) {
          const loan = await response.json();
          loans.push(loan);
          
          book.available--;
          member.activeLoans++;
          
          form.reset();
          showMessage('Empr√©stimo registrado com sucesso!');
          render();
        }
      } catch(error) {
        showMessage('Erro ao registrar empr√©stimo!', 'error');
      }
    }

    async function handleLoanFromReservation(reservationId) {
      try {
        const reservation = reservations.find(r => r.id === reservationId);
        if(!reservation) {
          showMessage('Reserva n√£o encontrada!', 'error');
          return;
        }

        const book = books.find(b => b.id === reservation.bookId);
        const member = members.find(m => m.id === reservation.memberId);

        if(!book || book.available <= 0) {
          showMessage('Livro n√£o dispon√≠vel para empr√©stimo!', 'error');
          return;
        }

        if(member.activeLoans >= systemConfig.maxLoansPerMember) {
          showMessage('Leitor atingiu o limite de empr√©stimos!', 'error');
          return;
        }

        handleCancelReservation(reservationId);

        const loanDate = new Date();
        const returnDate = new Date(loanDate);
        returnDate.setDate(returnDate.getDate() + systemConfig.loanDays);

        const loanResponse = await fetch('/api/loans', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bookId: reservation.bookId,
            memberId: reservation.memberId,
            loanDate: loanDate.toISOString(),
            returnDate: returnDate.toISOString()
          })
        });

        if(loanResponse.ok) {
          const loan = await loanResponse.json();
          loans.push(loan);

          book.available--;
          member.activeLoans++;

          reservation.status = 'Completed';

          showMessage('Empr√©stimo realizado a partir da reserva!', 'success');
          render();
        }
      } catch(error) {
        showMessage('Erro ao processar empr√©stimo da reserva!', 'error');
      }
    }

    async function handleReturnLoan(loanId) {
      try {
        const response = await fetch(`/api/loans/${loanId}/return`, { method: 'PUT' });

        if(response.ok) {
          const loan = loans.find(l => l.id === loanId);
          loan.status = 'returned';
          loan.returnedDate = new Date().toISOString();

          const book = books.find(b => b.id === loan.bookId);
          const member = members.find(m => m.id === loan.memberId);

          if(book)
            book.available++;
          if(member)
            member.activeLoans--;

          showMessage('Devolu√ß√£o registrada com sucesso!');
          render();
        }
      } catch(error) {
        showMessage('Erro ao registrar devolu√ß√£o!', 'error');
      }
    }

    function handleUpdateConfig(e) {
      e.preventDefault();
      e.stopPropagation();
      const form = e.target;
      
      systemConfig = {
        loanDays: parseInt(form.loanDays.value),
        toleranceDays: parseInt(form.toleranceDays.value),
        maxLoansPerMember: parseInt(form.maxLoansPerMember.value),
        allowRenewal: form.allowRenewal.checked,
        renewalDays: parseInt(form.renewalDays.value)
      };

      showMessage('Configura√ß√µes atualizadas com sucesso!');
      render();
    }

    async function handleCancelReservation(reservationId) {
      try {
        const response = await fetch(`/api/reservations/${reservationId}/cancel`, {
          method: 'PUT'
        });

        if(response.ok) {
          const reservation = reservations.find(r => r.id === reservationId);
          reservation.status = 'Cancelled';
          showMessage('Reserva cancelada com sucesso!', 'success');
          render();
        }
      } catch(error) {
        showMessage('Erro ao cancelar reserva!', 'error');
      }
    }

    async function handleReserveClick(bookId) {
      try {
        if(currentUser.role === 'member') {
          const member = members.find(m => m.email === currentUser.email);

          if(!member) {
            showMessage('Leitor n√£o encontrado no sistema!', 'error');
            return;
          }

          const existingReservation = reservations.find(r => 
            r.bookId === bookId && r.memberId === member.id && r.status === 'Active'
          );

          if(existingReservation) {
            showMessage('Voc√™ j√° tem uma reserva ativa para este livro!', 'warning');
            return;
          }

          const activeReservations = reservations.filter(r => 
            r.memberId === member.id && r.status === 'Active'
          ).length;

          if(activeReservations >= 2) {
            showMessage('Limite de reservas atingido! M√°ximo 2 reservas ativas.', 'error');
            return;
          }
        }

        const response = await fetch('/api/reservations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            bookId: bookId,
            memberId: currentUser.role === 'member' ? members.find(m => m.email === currentUser.email).id : null,
          })
        });

        if(response.ok) {
          const reservation = await response.json();
          reservations.push(reservation);
          showMessage('Reserva registrada com sucesso!', 'success');
          render();
        } else {
          const err = await response.json();
          showMessage(err.error || 'Erro ao registrar reserva!', 'error');
        }

      } catch(error) {
        console.error(error);
        showMessage('Erro de comunica√ß√£o com o servidor!', 'error');
      }
    }

    function toggleStaffStatus(staffId) {
      const person = staff.find(s => s.id === staffId);
      if(person) {
        person.active = !person.active;
        showMessage('Status atualizado!');
        render();
      }
    }

    function getReservationStatus(reservation) {
      const now = new Date();
      const expiryDate = new Date(reservation.reservationDate);
      expiryDate.setDate(expiryDate.getDate() + systemConfig.reservationDays);

      if(reservation.status === 'completed')
        return { text: 'Conclu√≠da', class: 'badge-success' };
      if(reservation.status === 'cancelled')
        return { text: 'Cancelada', class: 'badge-danger' };
      if(reservation.status === 'Active') {
        if(now > expiryDate)
          return { text: 'Expirada', class: 'badge-warning' };
        return { text: 'Ativa', class: 'badge-info' };
      }
      return { text: reservation.status, class: 'badge-secondary' };
    }

    async function markNotificationAsRead(notificationId) {
      try {
        const response = await fetch(`/api/notifications/${notificationId}/read`, {
          method: 'PUT'
        });

        if(response.ok) {
          const notification = notifications.find(n => n.id === notificationId);
          if(notification)
            notification.status = 'read';
          showMessage('Notifica√ß√£o marcada como lida!', 'success');
          render();
        }
      } catch(error) {
        showMessage('Erro ao marcar notifica√ß√£o!', 'error');
      }
    }

    function render() {
      const app = document.getElementById('app');
      
      if(!currentUser) {
        app.innerHTML = renderLoginPage();
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
      } else {
        app.innerHTML = renderMainPage();
        attachEventListeners();
      }
    }

    function renderLoginPage() {
      return `
        <div class="login-container">
          <div class="login-card">
            <div class="login-header">
              <div class="login-icon">üìö</div>
              <h1>BiblioSys</h1>
              <p>Sistema de Controle de Biblioteca</p>
            </div>

            <form id="loginForm">
              <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="loginEmail" required>
              </div>

              <div class="form-group">
                <label>Senha</label>
                <input type="password" id="loginPassword" required>
              </div>

              <button type="submit" class="btn btn-primary">Entrar</button>
            </form>

            <div class="test-credentials">
              <p><strong>Credenciais de teste:</strong></p>
              <p>Bibliotec√°ria: ana@biblioteca.com / 123456</p>
              <p>Gestora: maria@biblioteca.com / 123456</p>
              <p>Admin: admin@biblioteca.com / admin</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderOverdues() {
      if(!canAccess(['admin', 'manager', 'librarian']))
        return '';

      const overdueLoans = getOverdueLoans();

      return `
        <div class="card">
          <h2>üìÖ Empr√©stimos em Atraso</h2>

          ${overdueLoans.length === 0 ? `
            <p style="text-align: center; color: #666; padding: 2rem;">
              Nenhum empr√©stimo em atraso no momento.
            </p>
          ` : `
            <table>
              <thead>
                <tr>
                  <th>Livro</th>
                  <th>Leitor</th>
                  <th style="text-align: center;">Data Empr√©stimo</th>
                  <th style="text-align: center;">Data Devolu√ß√£o</th>
                  <th style="text-align: center;">Dias de Atraso</th>
                  <th style="text-align: center;">A√ß√£o</th>
                </tr>
              </thead>
              <tbody>
                ${overdueLoans.map(loan => {
                  const now = new Date();
                  const returnDate = new Date(loan.returnDate);
                  const toleranceDate = new Date(returnDate);
                  toleranceDate.setDate(toleranceDate.getDate() + systemConfig.toleranceDays);

                  const diffDays = Math.floor((now - toleranceDate) / (1000 * 60 * 60 * 24));

                  return `
                    <tr class="row-overdue">
                      <td><strong>${loan.bookTitle}</strong></td>
                      <td>${loan.memberName}</td>
                      <td style="text-align: center;">${new Date(loan.loanDate).toLocaleDateString('pt-BR')}</td>
                      <td style="text-align: center;">${new Date(loan.returnDate).toLocaleDateString('pt-BR')}</td>
                      <td style="text-align: center;">
                        <span class="badge badge-danger">${diffDays} dia(s)</span>
                      </td>
                      <td style="text-align: center;">
                        <button onclick="handleReturnLoan(${loan.id})" class="btn btn-success btn-small">Registrar Devolu√ß√£o</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `}
        </div>
      `;
    }

    function renderMainPage() {
      return `
        <header>
          <div class="header-content">
            <div class="header-left">
              <div>
                <h1>üìö BiblioSys</h1>
                <p>${getRoleLabel(currentUser.role)}</p>
              </div>
            </div>
            <div class="header-right">
              <div class="user-info">
                <p><strong>${currentUser.name}</strong></p>
                <p>${currentUser.email}</p>
              </div>
              <button onclick="handleLogout()" class="btn btn-secondary btn-small">Sair</button>
            </div>
          </div>
        </header>

        <nav>
          <div class="nav-buttons">
            ${canAccess(['admin', 'manager', 'librarian']) ? `
              <button class="nav-btn ${currentSection === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')">
                üìä Dashboard
              </button>
            ` : ''}
            ${canAccess(['admin', 'manager', 'librarian', 'member']) ? `
              <button class="nav-btn ${currentSection === 'books' ? 'active' : ''}" onclick="navigateTo('books')">
                üìñ Livros
              </button>
            ` : ''}
            ${canAccess(['admin', 'manager', 'librarian']) ? `
              <button class="nav-btn ${currentSection === 'members' ? 'active' : ''}" onclick="navigateTo('members')">
                üë• Leitores
              </button>
              <button class="nav-btn ${currentSection === 'loans' ? 'active' : ''}" onclick="navigateTo('loans')">
                üìã Empr√©stimos
              </button>
              <button class="nav-btn ${currentSection === 'overdues' ? 'active' : ''}" onclick="navigateTo('overdues')">
                ‚è∞ Atrasos
              </button>
            ` : ''}
            ${canAccess(['admin', 'manager', 'librarian']) ? `
              <button class="nav-btn ${currentSection === 'notifications' ? 'active' : ''}" onclick="navigateTo('notifications')">
                üîî Notifica√ß√µes
                ${notifications.filter(n => n.status === 'pending').length > 0 
                  ? `<span style="background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; margin-left: 0.3rem;">
                      ${notifications.filter(n => n.status === 'pending').length}
                    </span>`
                  : ''
                }
              </button>
            ` : ''}
            ${canAccess(['admin', 'manager']) ? `
              <button class="nav-btn ${currentSection === 'reports' ? 'active' : ''}" onclick="navigateTo('reports')">
                üìä Relat√≥rios
              </button>
            ` : ''}
            ${canAccess(['admin', 'manager']) ? `
              <button class="nav-btn ${currentSection === 'staff' ? 'active' : ''}" onclick="navigateTo('staff')">
                üë§ Funcion√°rios
              </button>
              <button class="nav-btn ${currentSection === 'config' ? 'active' : ''}" onclick="navigateTo('config')">
                ‚öôÔ∏è Configura√ß√µes
              </button>
            ` : ''}
          </div>
        </nav>

        <main>
          ${renderSection()}
        </main>

        <footer style="background: #2c3e50; color: white; text-align: center; padding: 1rem; margin-top: 2rem;">
          <p>BiblioSys ¬© 2025 - Sistema de Controle de Biblioteca</p>
          <p style="font-size: 0.85rem; opacity: 0.8;">Desenvolvido para N385 - Projeto e Desenvolvimento de Sistemas</p>
        </footer>
      `;
    }

    function renderSection() {
      switch(currentSection) {
        case 'dashboard': return renderDashboard();
        case 'books': return renderBooks();
        case 'members': return renderMembers();
        case 'loans': return renderLoans();
        case 'staff': return renderStaff();
        case 'config': return renderConfig();
        case 'overdues': return renderOverdues();
        case 'reports': return renderReports();
        case 'notifications': return renderNotifications();
        default: return renderDashboard();
      }
    }

    function renderDashboard() {
      const activeLoans = loans.filter(l => l.status === 'Active').length;
      const overdueLoans = getOverdueLoans().length;

      return `
        <div class="card">
          <h2>Dashboard</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">${books.length}</div>
              <div class="stat-label">Total de Livros</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${members.length}</div>
              <div class="stat-label">Leitores Cadastrados</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${activeLoans}</div>
              <div class="stat-label">Empr√©stimos Ativos</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${overdueLoans}</div>
              <div class="stat-label">Empr√©stimos em Atraso</div>
            </div>
          </div>

          ${canAccess(['admin', 'manager']) ? `
            <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Configura√ß√µes Atuais</h3>
            <div class="stats-grid">
              <div class="stat-card" style="background: linear-gradient(45deg, #3498db, #2980b9);">
                <div class="stat-number">${systemConfig.loanDays}</div>
                <div class="stat-label">Prazo de Empr√©stimo (dias)</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                <div class="stat-number">${systemConfig.toleranceDays}</div>
                <div class="stat-label">Toler√¢ncia de Atraso (dias)</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">
                <div class="stat-number">${systemConfig.maxLoansPerMember}</div>
                <div class="stat-label">Limite por Leitor</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                <div class="stat-number">${systemConfig.allowRenewal ? systemConfig.renewalDays : 0}</div>
                <div class="stat-label">Renova√ß√£o (dias)</div>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderBooks() {
      if(!canAccess(['admin', 'manager', 'librarian', 'member']))
        return '';

      return `
        <div class="card">
          <h2>Gerenciamento de Livros</h2>

          ${canAccess(['admin', 'manager', 'librarian']) ? `
          <h3 style="margin-bottom: 1rem;">Cadastrar Novo Livro</h3>
          <form id="bookForm" class="form-grid">
            <div class="form-group">
              <label>T√≠tulo *</label>
              <input type="text" name="title" required>
            </div>
            <div class="form-group">
              <label>Autor *</label>
              <input type="text" name="author" required>
            </div>
            <div class="form-group">
              <label>Categoria</label>
              <input type="text" name="category">
            </div>
            <div class="form-group">
              <label>Quantidade *</label>
              <input type="number" name="count" min="1" value="1" required>
            </div>
            <div class="form-group">
              <label style="opacity: 0;">.</label>
              <button type="submit" class="btn btn-success">Adicionar Livro</button>
            </div>
          </form>` : ''}

          <table>
            <thead>
              <tr>
                <th>T√≠tulo</th>
                <th>Autor</th>
                <th>Categoria</th>
                <th style="text-align: center;">Total</th>
                <th style="text-align: center;">Dispon√≠vel</th>
                <th style="text-align: center;">Reservas</th>
                <th style="text-align: center;">Status</th>
                <th style="text-align: center;">A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              ${books.map(book => {
                const bookReservations = reservations.filter(r => r.bookId === book.id && r.status === 'Active');
                return `
                <tr>
                  <td><strong>${book.title}</strong></td>
                  <td>${book.author}</td>
                  <td>${book.category || 'N/A'}</td>
                  <td style="text-align: center;">${book.count}</td>
                  <td style="text-align: center;">${book.available}</td>
                  <td style="text-align: center;">
                    ${bookReservations.length > 0 
                      ? `<span class="reservation-badge">${bookReservations.length}</span>`
                      : '-'
                    }
                  </td>
                  <td style="text-align: center;">
                    ${book.available > 0 
                      ? '<span class="badge badge-success">Dispon√≠vel</span>'
                      : '<span class="badge badge-danger">Indispon√≠vel</span>'
                    }
                  </td>
                  <td style="text-align: center;"> ${book.available > 0 ? '<button class="btn btn-success btn-reserve" data-book-id="' + book.id + '">Reservar</button>' : '' } </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderMembers() {
      if(!canAccess(['admin', 'manager', 'librarian']))
        return '';

      return `
        <div class="card">
          <h2>Gerenciamento de Leitores</h2>
          
          <h3 style="margin-bottom: 1rem;">Cadastrar Novo Leitor</h3>
          <form id="memberForm" class="form-grid">
            <div class="form-group">
              <label>Nome *</label>
              <input type="text" name="name" required>
            </div>
            <div class="form-group">
              <label>Contato *</label>
              <input type="tel" name="contact" placeholder="(34) 99999-9999" required>
            </div>
            <div class="form-group">
              <label>E-mail</label>
              <input type="email" name="email">
            </div>
            <div class="form-group">
              <label style="opacity: 0;">.</label>
              <button type="submit" class="btn btn-success">Cadastrar Leitor</button>
            </div>
          </form>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Contato</th>
                <th>E-mail</th>
                <th style="text-align: center;">Empr√©stimos Ativos</th>
              </tr>
            </thead>
            <tbody>
              ${members.map(member => `
                <tr>
                  <td><strong>${member.name}</strong></td>
                  <td>${member.contact}</td>
                  <td>${member.email || 'N/A'}</td>
                  <td style="text-align: center;">
                    <span class="badge ${member.activeLoans >= systemConfig.maxLoansPerMember ? 'badge-danger' : 'badge-info'}">
                      ${member.activeLoans || 0}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderLoans() {
      if(!canAccess(['admin', 'manager', 'librarian']))
        return '';

      const availableBooks = books.filter(b => b.available > 0);
      const availableMembers = members.filter(m => (m.activeLoans || 0) < systemConfig.maxLoansPerMember);

      return `
        <div class="card">
          <h2>Gerenciamento de Empr√©stimos</h2>
          
          <h3 style="margin-bottom: 1rem;">Registrar Novo Empr√©stimo</h3>
          <form id="loanForm" class="form-grid">
            <div class="form-group">
              <label>Livro *</label>
              <select name="loanBook" required>
                <option value="">Selecione um livro</option>
                ${availableBooks.map(book => `
                  <option value="${book.id}">${book.title} (${book.available} dispon√≠vel)</option>
                `).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Leitor *</label>
              <select name="loanMember" required>
                <option value="">Selecione um leitor</option>
                ${availableMembers.map(member => `
                  <option value="${member.id}">${member.name}</option>
                `).join('')}
              </select>
            </div>
            <div class="form-group">
              <label style="opacity: 0;">.</label>
              <button type="submit" class="btn btn-success">Registrar Empr√©stimo</button>
            </div>
          </form>

          <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Reservas Ativas</h3>
          ${reservations.filter(r => r.status === 'Active').length === 0 ? `
            <p style="text-align: center; color: #666; padding: 2rem;">Nenhuma reserva ativa no momento.</p>
          ` : `
            <table>
              <thead>
                <tr>
                  <th>Livro</th>
                  <th>Leitor</th>
                  <th style="text-align: center;">Data Reserva</th>
                  <th style="text-align: center;">Expira em</th>
                  <th style="text-align: center;">Status</th>
                  <th style="text-align: center;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                ${reservations
                  .filter(r => r.status === 'Active')
                  .map(reservation => {
                    const status = getReservationStatus(reservation);
                    const expiryDate = new Date(reservation.reservationDate);
                    expiryDate.setDate(expiryDate.getDate() + systemConfig.reservationDays);

                    return `
                      <tr>
                        <td><strong>${reservation.bookTitle}</strong></td>
                        <td>${reservation.memberName}</td>
                        <td style="text-align: center;">${reservation.reservationDate}</td>
                        <td style="text-align: center;">${expiryDate.toLocaleDateString('pt-BR')}</td>
                        <td style="text-align: center;">
                          <span class="badge ${status.class}">${status.text}</span>
                        </td>
                        <td style="text-align: center;">
                          <button onclick="handleLoanFromReservation(${reservation.id})" class="btn btn-success btn-small">
                            Emprestar
                          </button>
                          <button onclick="handleCancelReservation(${reservation.id})" class="btn btn-danger btn-small">
                            Cancelar
                          </button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
              </tbody>
            </table>
          `}

          <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Hist√≥rico de Empr√©stimos</h3>
          <table>
            <thead>
              <tr>
                <th>Livro</th>
                <th>Leitor</th>
                <th style="text-align: center;">Data Empr√©stimo</th>
                <th style="text-align: center;">Data Devolu√ß√£o</th>
                <th style="text-align: center;">Status</th>
                <th style="text-align: center;">A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              ${loans.map(loan => {
                const isOverdue = isLoanOverdue(loan);
                return `
                  <tr class="${isOverdue ? 'row-overdue' : ''}">
                    <td><strong>${loan.bookTitle}</strong></td>
                    <td>${loan.memberName}</td>
                    <td style="text-align: center;">${new Date(loan.loanDate).toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: center;">${new Date(loan.returnDate).toLocaleDateString('pt-BR')}</td>
                    <td style="text-align: center;">
                      ${loan.status === 'Active' 
                        ? (isOverdue 
                          ? '<span class="badge badge-danger">Em Atraso</span>'
                          : '<span class="badge badge-info">Ativo</span>')
                        : '<span class="badge badge-success">Devolvido</span>'
                      }
                    </td>
                    <td style="text-align: center;">
                      ${loan.status === 'Active' 
                        ? `<button onclick="handleReturnLoan(${loan.id})" class="btn btn-success btn-small">Devolver</button>`
                        : '-'
                      }
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderStaff() {
      if(!canAccess(['admin', 'manager']))
        return '';

      return `
        <div class="card">
          <h2>Gerenciamento de Funcion√°rios</h2>
          
          <h3 style="margin-bottom: 1rem;">Cadastrar Novo Funcion√°rio</h3>
          <form id="staffForm" class="form-grid">
            <div class="form-group">
              <label>Nome *</label>
              <input type="text" name="staffName" required>
            </div>
            <div class="form-group">
              <label>E-mail *</label>
              <input type="email" name="staffEmail" required>
            </div>
            <div class="form-group">
              <label>Senha *</label>
              <input type="password" name="staffPassword" required>
            </div>
            <div class="form-group">
              <label>Cargo *</label>
              <select name="staffRole" required>
                <option value="librarian">Bibliotec√°rio(a)</option>
                ${currentUser.role === 'admin' ? `
                  <option value="manager">Gestor(a)</option>
                  <option value="admin">Administrador(a)</option>
                ` : ''}
              </select>
            </div>
            <div class="form-group">
              <label style="opacity: 0;">.</label>
              <button type="submit" class="btn btn-success">Adicionar Funcion√°rio</button>
            </div>
          </form>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th style="text-align: center;">Cargo</th>
                <th style="text-align: center;">Status</th>
                <th style="text-align: center;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              ${staff.map(person => `
                <tr>
                  <td><strong>${person.name}</strong></td>
                  <td>${person.email}</td>
                  <td style="text-align: center;">
                    <span class="badge badge-primary">${getRoleLabel(person.role)}</span>
                  </td>
                  <td style="text-align: center;">
                    ${person.active 
                      ? '<span class="badge badge-success">Ativo</span>'
                      : '<span class="badge badge-danger">Inativo</span>'
                    }
                  </td>
                  <td style="text-align: center;">
                    ${person.id !== currentUser.id 
                      ? `<button onclick="toggleStaffStatus(${person.id})" class="btn ${person.active ? 'btn-danger' : 'btn-success'} btn-small">
                          ${person.active ? 'Desativar' : 'Ativar'}
                        </button>`
                      : '-'
                    }
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderConfig() {
      if(!canAccess(['admin', 'manager']))
        return '';

      const exampleDate = new Date('2025-01-01');
      const returnDate = new Date(exampleDate);
      returnDate.setDate(returnDate.getDate() + systemConfig.loanDays);
      const toleranceDate = new Date(returnDate);
      toleranceDate.setDate(toleranceDate.getDate() + systemConfig.toleranceDays);

      return `
        <div class="card">
          <h2>Configura√ß√µes do Sistema</h2>
          
          <h3 style="margin-bottom: 1rem;">Par√¢metros de Empr√©stimo</h3>
          <form id="configForm">
            <div class="form-grid">
              <div class="form-group">
                <label>Prazo de Empr√©stimo (dias) *</label>
                <input type="number" name="loanDays" value="${systemConfig.loanDays}" min="1" required>
                <small style="color: #666; font-size: 0.85rem;">
                  Per√≠odo padr√£o que um leitor pode manter um livro emprestado
                </small>
              </div>

              <div class="form-group">
                <label>Dias de Toler√¢ncia para Atraso *</label>
                <input type="number" name="toleranceDays" value="${systemConfig.toleranceDays}" min="0" required>
                <small style="color: #666; font-size: 0.85rem;">
                  Per√≠odo de toler√¢ncia antes de considerar o empr√©stimo em atraso
                </small>
              </div>

              <div class="form-group">
                <label>Limite de Empr√©stimos por Leitor *</label>
                <input type="number" name="maxLoansPerMember" value="${systemConfig.maxLoansPerMember}" min="1" required>
                <small style="color: #666; font-size: 0.85rem;">
                  N√∫mero m√°ximo de livros que um leitor pode emprestar simultaneamente
                </small>
              </div>

              <div class="form-group">
                <label>
                  <input type="checkbox" name="allowRenewal" ${systemConfig.allowRenewal ? 'checked' : ''}>
                  Permitir Renova√ß√£o
                </label>
                <input type="number" name="renewalDays" value="${systemConfig.renewalDays}" min="1" placeholder="Dias de renova√ß√£o" style="margin-top: 0.5rem;">
                <small style="color: #666; font-size: 0.85rem;">
                  Permite que leitores renovem empr√©stimos e define o per√≠odo adicional
                </small>
              </div>
            </div>

            <div style="text-align: right; margin-top: 1.5rem;">
              <button type="submit" class="btn btn-primary" style="width: auto; padding: 1rem 2rem;">
                Salvar Configura√ß√µes
              </button>
            </div>
          </form>
        </div>

        <div class="card config-info">
          <h3>‚è∞ Como Funciona o Controle de Atrasos</h3>
          <p><strong>Exemplo com configura√ß√µes atuais:</strong></p>
          <ul>
            <li>Empr√©stimo realizado: 01/01/2025</li>
            <li>Data limite de devolu√ß√£o: ${returnDate.toLocaleDateString('pt-BR')} (${systemConfig.loanDays} dias ap√≥s empr√©stimo)</li>
            <li>Per√≠odo de toler√¢ncia: at√© ${toleranceDate.toLocaleDateString('pt-BR')} (+${systemConfig.toleranceDays} dias)</li>
            <li>Considerado em atraso ap√≥s: ${toleranceDate.toLocaleDateString('pt-BR')}</li>
          </ul>
          <div class="info-box">
            <p>
              üí° <strong>Dica:</strong> O per√≠odo de toler√¢ncia permite uma margem antes de notificar atrasos, 
              considerando feriados e fins de semana. Empr√©stimos s√≥ aparecem como "em atraso" 
              ap√≥s ultrapassar o per√≠odo de devolu√ß√£o + toler√¢ncia.
            </p>
          </div>
        </div>

        <div class="card">
          <h3>Informa√ß√µes do Sistema</h3>
          <div class="stats-grid">
            <div class="stat-card" style="background: linear-gradient(45deg, #3498db, #2980b9);">
              <div class="stat-number">1.0.0</div>
              <div class="stat-label">Vers√£o</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">
              <div class="stat-number">${staff.filter(s => s.active).length}</div>
              <div class="stat-label">Funcion√°rios Ativos</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
              <div class="stat-number">${books.reduce((sum, b) => sum + b.count, 0)}</div>
              <div class="stat-label">Acervo Total</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderReports() {
      if(!canAccess(['admin', 'manager']))
        return '';

      return `
        <div class="card">
          <h2>üìä Relat√≥rios e Estat√≠sticas</h2>
          
          <div class="stats-grid" style="margin-bottom: 2rem;">
            <button class="stat-card" onclick="loadReport('most-borrowed')" style="cursor: pointer; border: none;">
              <div class="stat-label">üìö Livros Mais Emprestados</div>
            </button>
            <button class="stat-card" onclick="loadReport('active-members')" style="cursor: pointer; border: none;">
              <div class="stat-label">üë• Leitores Mais Ativos</div>
            </button>
            <button class="stat-card" onclick="loadReport('overdue-summary')" style="cursor: pointer; border: none;">
              <div class="stat-label">‚è∞ Resumo de Atrasos</div>
            </button>
            <button class="stat-card" onclick="loadReport('collection-stats')" style="cursor: pointer; border: none;">
              <div class="stat-label">üìñ Estat√≠sticas do Acervo</div>
            </button>
          </div>

          <div id="reportContent"></div>
        </div>
      `;
    }

    async function loadReport(reportType) {
      const reportContent = document.getElementById('reportContent');
      reportContent.innerHTML = '<p style="text-align: center; padding: 2rem;">Carregando relat√≥rio...</p>';

      try {
        const response = await fetch(`/api/reports/${reportType}`);
        const report = await response.json();

        let html = `
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-top: 1rem;">
            <h3 style="margin-bottom: 1rem; color: #2c3e50;">${report.title}</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
              Gerado em: ${new Date(report.generatedAt).toLocaleString('pt-BR')}
            </p>
        `;

        if(reportType === 'most-borrowed') {
          if(report.data.length === 0) {
            html += '<p style="text-align: center; color: #666;">Nenhum empr√©stimo registrado ainda.</p>';
          } else {
            html += `
              <table>
                <thead>
                  <tr>
                    <th style="text-align: center;">Posi√ß√£o</th>
                    <th>T√≠tulo</th>
                    <th>Autor</th>
                    <th style="text-align: center;">Empr√©stimos</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.data.map((book, index) => `
                    <tr>
                      <td style="text-align: center;">
                        <strong style="font-size: 1.2rem; color: #667eea;">#${index + 1}</strong>
                      </td>
                      <td><strong>${book.title}</strong></td>
                      <td>${book.author}</td>
                      <td style="text-align: center;">
                        <span class="badge badge-info">${book.loanCount}</span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if(reportType === 'active-members') {
          if(report.data.length === 0) {
            html += '<p style="text-align: center; color: #666;">Nenhum leitor com empr√©stimos registrados.</p>';
          } else {
            html += `
              <table>
                <thead>
                  <tr>
                    <th style="text-align: center;">Posi√ß√£o</th>
                    <th>Nome</th>
                    <th>Contato</th>
                    <th style="text-align: center;">Total de Empr√©stimos</th>
                    <th style="text-align: center;">Empr√©stimos Ativos</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.data.map((member, index) => `
                    <tr>
                      <td style="text-align: center;">
                        <strong style="font-size: 1.2rem; color: #667eea;">#${index + 1}</strong>
                      </td>
                      <td><strong>${member.name}</strong></td>
                      <td>${member.contact}</td>
                      <td style="text-align: center;">
                        <span class="badge badge-info">${member.loanCount}</span>
                      </td>
                      <td style="text-align: center;">
                        <span class="badge badge-primary">${member.activeLoans}</span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if(reportType === 'overdue-summary') {
          html += `
            <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <strong style="color: #856404;">Total de empr√©stimos em atraso: ${report.totalOverdue}</strong>
            </div>
          `;
          
          if(report.data.length === 0) {
            html += '<p style="text-align: center; color: #666;">Nenhum empr√©stimo em atraso! üéâ</p>';
          } else {
            html += `
              <table>
                <thead>
                  <tr>
                    <th>Livro</th>
                    <th>Leitor</th>
                    <th style="text-align: center;">Data de Devolu√ß√£o</th>
                    <th style="text-align: center;">Dias de Atraso</th>
                  </tr>
                </thead>
                <tbody>
                  ${report.data.map(loan => `
                    <tr class="row-overdue">
                      <td><strong>${loan.bookTitle}</strong></td>
                      <td>${loan.memberName}</td>
                      <td style="text-align: center;">${new Date(loan.returnDate).toLocaleDateString('pt-BR')}</td>
                      <td style="text-align: center;">
                        <span class="badge badge-danger">${loan.daysOverdue} dia(s)</span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if(reportType === 'collection-stats') {
          const data = report.data;
          html += `
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
              <div class="stat-card" style="background: linear-gradient(45deg, #3498db, #2980b9);">
                <div class="stat-number">${data.totalBooks}</div>
                <div class="stat-label">Livros no Acervo</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(45deg, #2ecc71, #27ae60);">
                <div class="stat-number">${data.availableBooks}</div>
                <div class="stat-label">Livros Dispon√≠veis</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                <div class="stat-number">${data.loanedBooks}</div>
                <div class="stat-label">Livros Emprestados</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                <div class="stat-number">${data.utilizationRate}%</div>
                <div class="stat-label">Taxa de Utiliza√ß√£o</div>
              </div>
            </div>

            <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">üìö Distribui√ß√£o por Categoria</h4>
            <table>
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th style="text-align: center;">Quantidade de Livros</th>
                </tr>
              </thead>
              <tbody>
                ${data.categories.map(cat => `
                  <tr>
                    <td><strong>${cat.name}</strong></td>
                    <td style="text-align: center;">
                      <span class="badge badge-info">${cat.count}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        html += '</div>';
        reportContent.innerHTML = html;

      } catch(error) {
        console.error('Erro ao carregar relat√≥rio:', error);
        reportContent.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 2rem;">Erro ao carregar relat√≥rio!</p>';
      }
    }

    function renderNotifications() {
      if(!canAccess(['admin', 'manager', 'librarian']))
        return '';

      const pendingNotifications = notifications.filter(n => n.status === 'pending');
      const readNotifications = notifications.filter(n => n.status === 'read');
      const resolvedNotifications = notifications.filter(n => n.status === 'resolved');

      return `
        <div class="card">
          <h2>üîî Central de Notifica√ß√µes</h2>

          ${pendingNotifications.length === 0 && readNotifications.length === 0 && resolvedNotifications.length === 0 ? `
            <p style="text-align: center; color: #666; padding: 2rem;">
              Nenhuma notifica√ß√£o no momento. üòä
            </p>
          ` : ''}

          ${pendingNotifications.length > 0 ? `
            <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #e74c3c;">
              ‚ö†Ô∏è Notifica√ß√µes Pendentes (${pendingNotifications.length})
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              ${pendingNotifications.map(notification => `
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                    <div style="flex: 1;">
                      <strong style="color: #856404; display: block; margin-bottom: 0.5rem;">
                        ${notification.type === 'overdue' ? '‚è∞ Empr√©stimo em Atraso' : 'üì¢ Notifica√ß√£o'}
                      </strong>
                      <p style="margin: 0.5rem 0; color: #333;">${notification.message}</p>
                      <small style="color: #666;">
                        ${new Date(notification.createdAt).toLocaleString('pt-BR')}
                      </small>
                    </div>
                    <button onclick="markNotificationAsRead(${notification.id})" 
                            class="btn btn-primary btn-small" 
                            style="white-space: nowrap;">
                      Marcar como Lida
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}

          ${readNotifications.length > 0 ? `
            <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: #3498db;">
              ‚úì Notifica√ß√µes Lidas (${readNotifications.length})
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              ${readNotifications.map(notification => `
                <div style="background: #d1ecf1; border-left: 4px solid #3498db; padding: 1rem; border-radius: 8px;">
                  <strong style="color: #0c5460; display: block; margin-bottom: 0.5rem;">
                    ${notification.type === 'overdue' ? '‚è∞ Empr√©stimo em Atraso' : 'üì¢ Notifica√ß√£o'}
                  </strong>
                  <p style="margin: 0.5rem 0; color: #333;">${notification.message}</p>
                  <small style="color: #666;">
                    Criada em: ${new Date(notification.createdAt).toLocaleString('pt-BR')} | 
                    Lida em: ${new Date(notification.readAt).toLocaleString('pt-BR')}
                  </small>
                </div>
              `).join('')}
            </div>
          ` : ''}

          ${resolvedNotifications.length > 0 ? `
            <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: #2ecc71;">
              ‚úÖ Notifica√ß√µes Resolvidas (${resolvedNotifications.length})
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              ${resolvedNotifications.slice(0, 10).map(notification => `
                <div style="background: #d4edda; border-left: 4px solid #2ecc71; padding: 1rem; border-radius: 8px;">
                  <strong style="color: #155724; display: block; margin-bottom: 0.5rem;">
                    ${notification.type === 'overdue' ? '‚è∞ Empr√©stimo em Atraso (Resolvido)' : 'üì¢ Notifica√ß√£o'}
                  </strong>
                  <p style="margin: 0.5rem 0; color: #333;">${notification.message}</p>
                  <small style="color: #666;">
                    Resolvida em: ${new Date(notification.resolvedAt).toLocaleString('pt-BR')}
                  </small>
                </div>
              `).join('')}
              ${resolvedNotifications.length > 10 ? `
                <p style="text-align: center; color: #666; font-size: 0.9rem;">
                  Mostrando as 10 notifica√ß√µes mais recentes de ${resolvedNotifications.length} resolvidas
                </p>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;
    }

    function attachEventListeners() {
      const bookForm = document.getElementById('bookForm');
      if(bookForm) {
        const newBookForm = bookForm.cloneNode(true);
        bookForm.parentNode.replaceChild(newBookForm, bookForm);
        newBookForm.addEventListener('submit', handleAddBook);
      }

      const memberForm = document.getElementById('memberForm');
      if(memberForm) {
        const newMemberForm = memberForm.cloneNode(true);
        memberForm.parentNode.replaceChild(newMemberForm, memberForm);
        newMemberForm.addEventListener('submit', handleAddMember);
      }

      const staffForm = document.getElementById('staffForm');
      if(staffForm) {
        const newStaffForm = staffForm.cloneNode(true);
        staffForm.parentNode.replaceChild(newStaffForm, staffForm);
        newStaffForm.addEventListener('submit', handleAddStaff);
      }

      const loanForm = document.getElementById('loanForm');
      if(loanForm) {
        const newLoanForm = loanForm.cloneNode(true);
        loanForm.parentNode.replaceChild(newLoanForm, loanForm);
        newLoanForm.addEventListener('submit', handleAddLoan);
      }

      const configForm = document.getElementById('configForm');
      if(configForm) {
        const newConfigForm = configForm.cloneNode(true);
        configForm.parentNode.replaceChild(newConfigForm, configForm);
        newConfigForm.addEventListener('submit', handleUpdateConfig);
      }

      document.querySelectorAll('.btn-reserve').forEach(btn => {
        btn.addEventListener('click', () => {
          const bookId = parseInt(btn.dataset.bookId);
          handleReserveClick(bookId);
        });
      });

      if(currentUser && canAccess(['admin', 'manager', 'librarian'])) {
        setTimeout(async () => {
          const notificationsRes = await fetch('/api/notifications');
          const newNotifications = await notificationsRes.json();
          const oldPendingCount = notifications.filter(n => n.status === 'pending').length;
          const newPendingCount = newNotifications.filter(n => n.status === 'pending').length;

          notifications = newNotifications;

          if(newPendingCount > oldPendingCount && currentSection !== 'notifications')
            showMessage('Novas notifica√ß√µes de atraso!', 'warning');

          if(currentSection === 'notifications')
            render();
        }, 30000);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
